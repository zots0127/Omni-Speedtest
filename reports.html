<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no, user-scalable=no" />
<title>测试报告 | Omni-Speedtest</title>
<link rel="shortcut icon" href="favicon.ico">
<style type="text/css">
    html,body{
        border:none; padding:0; margin:0;
        background:#FFFFFF;
        color:#202020;
        font-family:"Roboto",sans-serif;
    }
    body{
        text-align:center;
        padding: 20px;
    }
    h1{
        color:#404040;
        margin-bottom: 10px;
    }
    h2{
        color:#606060;
        margin: 20px 0 10px 0;
        font-size: 22px;
    }
    h3{
        color:#606060;
        margin: 15px 0 8px 0;
        font-size: 18px;
    }
    .nav-links {
        margin: 20px 0;
        padding: 10px;
        background: #f5f5f5;
        border-radius: 5px;
    }
    .nav-links a {
        margin: 0 15px;
        text-decoration: none;
        color: #6060AA;
        font-weight: 500;
    }
    .nav-links a:hover {
        color: #4040FF;
    }
    .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }
    .btn {
        display:inline-block;
        margin:10px;
        color:#FFFFFF;
        background-color:#6060AA;
        border:none;
        border-radius:0.3em;
        padding: 12px 24px;
        cursor:pointer;
        font-size: 16px;
        transition: all 0.3s;
    }
    .btn:hover{
        background-color:#4040FF;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    .btn-success {
        background-color:#309030;
    }
    .btn-success:hover {
        background-color:#207020;
    }
    .report-list {
        margin: 30px 0;
    }
    .report-card {
        background: #ffffff;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 20px;
        margin: 15px 0;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        text-align: left;
        cursor: pointer;
        transition: all 0.3s;
    }
    .report-card:hover {
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        transform: translateY(-2px);
    }
    .report-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 15px;
        border-bottom: 2px solid #e0e0e0;
    }
    .report-id {
        font-size: 18px;
        font-weight: bold;
        color: #404040;
    }
    .report-date {
        color: #808080;
        font-size: 14px;
    }
    .report-summary {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin: 15px 0;
    }
    .summary-item {
        padding: 10px;
        background: #f9f9f9;
        border-radius: 6px;
    }
    .summary-label {
        font-size: 12px;
        color: #808080;
        margin-bottom: 5px;
    }
    .summary-value {
        font-size: 20px;
        font-weight: bold;
        color: #404040;
    }
    .report-detail {
        display: none;
        margin-top: 20px;
        padding-top: 20px;
        border-top: 2px solid #e0e0e0;
    }
    .report-detail.active {
        display: block;
    }
    .stats-section {
        margin: 20px 0;
    }
    table {
        width: 100%;
        border-collapse: collapse;
        margin: 15px 0;
    }
    th, td {
        padding: 10px;
        text-align: left;
        border-bottom: 1px solid #e0e0e0;
    }
    th {
        background: #f5f5f5;
        font-weight: 600;
        color: #404040;
        font-size: 14px;
    }
    td {
        font-size: 14px;
    }
    .loading {
        text-align: center;
        padding: 40px;
        color: #606060;
        font-size: 18px;
    }
    .no-reports {
        text-align: center;
        padding: 60px 20px;
        color: #808080;
    }
    .export-btn {
        background-color: #FF8800;
        margin-left: 10px;
    }
    .export-btn:hover {
        background-color: #FF6600;
    }
    @media (prefers-color-scheme: dark) {
        html, body {
            background: #181818;
            color: #E0E0E0;
        }
        h1, h2, h3 {
            color: #FFFFFF;
        }
        .nav-links {
            background: #282828;
        }
        .nav-links a {
            color: #AAAAFF;
        }
        .nav-links a:hover {
            color: #CCCCFF;
        }
        .report-card {
            background: #282828;
            border-color: #404040;
        }
        .report-id {
            color: #E0E0E0;
        }
        .report-date {
            color: #A0A0A0;
        }
        .summary-item {
            background: #333333;
        }
        .summary-value {
            color: #E0E0E0;
        }
        th {
            background: #333333;
            color: #E0E0E0;
        }
        td {
            border-bottom-color: #404040;
        }
        .report-header, .report-detail {
            border-color: #404040;
        }
    }
    @media all and (max-width:768px){
        body{
            font-size: 14px;
            padding: 10px;
        }
        .report-summary {
            grid-template-columns: 1fr;
        }
        .report-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 10px;
        }
    }
</style>
</head>
<body>
<h1>测试报告</h1>
<p>查看和分析历史测试报告</p>

<div class="nav-links">
    <a href="./index.html">速度测试</a>
    <a href="./ping-test.html">延迟测试</a>
    <a href="./ping-dashboard.html">延迟分析</a>
    <a href="./results.html">测速记录</a>
    <a href="./reports.html">测试报告</a>
</div>

<div class="container">
    <div>
        <button class="btn btn-success" onclick="generateNewReport()">生成新报告</button>
        <button class="btn" onclick="loadReports()">刷新列表</button>
    </div>
    
    <div class="loading" id="loading">正在加载报告...</div>
    
    <div class="report-list" id="reportList" style="display:none;"></div>
    
    <div class="no-reports" id="noReports" style="display:none;">
        <h2>暂无报告</h2>
        <p>点击"生成新报告"按钮创建第一份测试报告</p>
    </div>
</div>

<script>
let reports = [];

async function loadReports() {
    document.getElementById('loading').style.display = 'block';
    document.getElementById('reportList').style.display = 'none';
    document.getElementById('noReports').style.display = 'none';
    
    try {
        const response = await fetch('./backend/report-generator.php?action=list&limit=50');
        const data = await response.json();
        
        if (data.success && data.reports.length > 0) {
            reports = data.reports;
            renderReports();
        } else {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('noReports').style.display = 'block';
        }
    } catch (error) {
        console.error('Failed to load reports:', error);
        document.getElementById('loading').textContent = '加载报告失败';
    }
}

function renderReports() {
    document.getElementById('loading').style.display = 'none';
    document.getElementById('reportList').style.display = 'block';
    
    const listContainer = document.getElementById('reportList');
    listContainer.innerHTML = '';
    
    reports.forEach((report, index) => {
        const card = document.createElement('div');
        card.className = 'report-card';
        card.onclick = () => toggleReportDetail(report.report_id, index);
        
        const summary = report.summary;
        
        card.innerHTML = `
            <div class="report-header">
                <div>
                    <div class="report-id">报告 #${index + 1}</div>
                    <div class="report-date">${report.created}</div>
                </div>
                <div>
                    <button class="btn export-btn" onclick="event.stopPropagation(); exportReport('${report.report_id}')">导出报告</button>
                </div>
            </div>
            <div class="report-summary">
                <div class="summary-item">
                    <div class="summary-label">速度测试</div>
                    <div class="summary-value">${summary.total_speed_tests || 0}</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">延迟测试</div>
                    <div class="summary-value">${summary.total_ping_tests || 0}</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">平均下载速度</div>
                    <div class="summary-value">${(summary.avg_download_speed || 0).toFixed(2)} Mbps</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">平均上传速度</div>
                    <div class="summary-value">${(summary.avg_upload_speed || 0).toFixed(2)} Mbps</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">平均延迟</div>
                    <div class="summary-value">${(summary.avg_ping || 0).toFixed(2)} ms</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">平均抖动</div>
                    <div class="summary-value">${(summary.avg_jitter || 0).toFixed(2)} ms</div>
                </div>
            </div>
            <div class="report-detail" id="detail_${report.report_id}">
                <div class="loading">加载详细信息中...</div>
            </div>
        `;
        
        listContainer.appendChild(card);
    });
}

async function toggleReportDetail(reportId, index) {
    const detailDiv = document.getElementById(`detail_${reportId}`);
    
    if (detailDiv.classList.contains('active')) {
        detailDiv.classList.remove('active');
        return;
    }
    
    document.querySelectorAll('.report-detail').forEach(div => {
        div.classList.remove('active');
    });
    
    detailDiv.classList.add('active');
    
    if (detailDiv.dataset.loaded) {
        return;
    }
    
    try {
        const response = await fetch(`./backend/report-generator.php?action=get&report_id=${reportId}`);
        const data = await response.json();
        
        if (data.success) {
            renderReportDetail(data.report, detailDiv);
            detailDiv.dataset.loaded = 'true';
        } else {
            detailDiv.innerHTML = '<p style="text-align:center; color:#FF3030;">加载失败</p>';
        }
    } catch (error) {
        console.error('Failed to load report detail:', error);
        detailDiv.innerHTML = '<p style="text-align:center; color:#FF3030;">加载失败</p>';
    }
}

function renderReportDetail(report, container) {
    const stats = report.statistics;
    
    let html = '<div class="stats-section">';
    
    if (stats.by_isp && Object.keys(stats.by_isp).length > 0) {
        html += '<h3>运营商统计</h3>';
        html += '<table><thead><tr><th>运营商</th><th>平均下载</th><th>平均上传</th><th>平均延迟</th><th>测试次数</th></tr></thead><tbody>';
        
        Object.entries(stats.by_isp).forEach(([isp, data]) => {
            html += `<tr>
                <td>${isp}</td>
                <td>${data.avg_download?.toFixed(2) || 0} Mbps</td>
                <td>${data.avg_upload?.toFixed(2) || 0} Mbps</td>
                <td>${data.avg_ping?.toFixed(2) || 0} ms</td>
                <td>${data.count}</td>
            </tr>`;
        });
        
        html += '</tbody></table>';
    }
    
    if (stats.by_region && Object.keys(stats.by_region).length > 0) {
        html += '<h3>地区统计</h3>';
        html += '<table><thead><tr><th>地区</th><th>平均下载</th><th>平均上传</th><th>平均延迟</th><th>测试次数</th></tr></thead><tbody>';
        
        Object.entries(stats.by_region).forEach(([region, data]) => {
            html += `<tr>
                <td>${region}</td>
                <td>${data.avg_download?.toFixed(2) || 0} Mbps</td>
                <td>${data.avg_upload?.toFixed(2) || 0} Mbps</td>
                <td>${data.avg_ping?.toFixed(2) || 0} ms</td>
                <td>${data.count}</td>
            </tr>`;
        });
        
        html += '</tbody></table>';
    }
    
    if (stats.global_ping && stats.global_ping.by_region && Object.keys(stats.global_ping.by_region).length > 0) {
        html += '<h3>全球延迟统计（按地区）</h3>';
        html += '<table><thead><tr><th>地区</th><th>平均延迟</th><th>最小延迟</th><th>最大延迟</th><th>测试次数</th></tr></thead><tbody>';
        
        Object.entries(stats.global_ping.by_region).forEach(([region, data]) => {
            html += `<tr>
                <td>${region}</td>
                <td>${data.avg?.toFixed(2) || 0} ms</td>
                <td>${data.min?.toFixed(2) || 0} ms</td>
                <td>${data.max?.toFixed(2) || 0} ms</td>
                <td>${data.count}</td>
            </tr>`;
        });
        
        html += '</tbody></table>';
    }
    
    if (stats.global_ping && stats.global_ping.by_country && Object.keys(stats.global_ping.by_country).length > 0) {
        html += '<h3>全球延迟统计（按国家）</h3>';
        html += '<table><thead><tr><th>国家</th><th>平均延迟</th><th>最小延迟</th><th>最大延迟</th><th>测试次数</th></tr></thead><tbody>';
        
        Object.entries(stats.global_ping.by_country).forEach(([country, data]) => {
            html += `<tr>
                <td>${country}</td>
                <td>${data.avg?.toFixed(2) || 0} ms</td>
                <td>${data.min?.toFixed(2) || 0} ms</td>
                <td>${data.max?.toFixed(2) || 0} ms</td>
                <td>${data.count}</td>
            </tr>`;
        });
        
        html += '</tbody></table>';
    }
    
    html += '</div>';
    
    container.innerHTML = html;
}

async function generateNewReport() {
    const btn = event.target;
    btn.disabled = true;
    btn.textContent = '生成中...';
    
    try {
        const response = await fetch('./backend/report-generator.php?action=generate&type=all');
        const data = await response.json();
        
        if (data.success) {
            alert('报告生成成功！');
            loadReports();
        } else {
            alert('报告生成失败: ' + data.error);
        }
    } catch (error) {
        console.error('Failed to generate report:', error);
        alert('报告生成失败');
    }
    
    btn.disabled = false;
    btn.textContent = '生成新报告';
}

async function exportReport(reportId) {
    try {
        const response = await fetch(`./backend/report-generator.php?action=get&report_id=${reportId}`);
        const data = await response.json();
        
        if (data.success) {
            const blob = new Blob([JSON.stringify(data.report, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `report_${reportId}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        } else {
            alert('导出失败');
        }
    } catch (error) {
        console.error('Failed to export report:', error);
        alert('导出失败');
    }
}

loadReports();
</script>
</body>
</html>
